# 指令表定时同步任务无法更新

问题现象：OT会每隔5分钟进行一个指令补漏的定时同步任务，防止O3的指令没有更新到OT,但是第一次排查时，指令补漏任务是正常进行的，后面就再也无法同步成功了

# 问题排查

第一次检查定时任务是否同步成功，在O3修改指令6的两个字段：

```oracle
update tinstruction set c_deal_execute_flag=0,L_FUND_ID=51808 where l_daily_instruction_no=6;
commit;
```

任务同步成功，然后就无法再同步成功，通过抓包，可以看到定时任务确实5分钟执行了一次，查看日志发现，对于O3返回的指令,OT在更新第6条时，出现报错，原因是我将指令的fund_id改成了51808
，但是资金账户表中并没有这条记录，导致查询失败。因此，我将这条指令从OT和O3删除，但仍然有问题，查询O3指令表返回的结果为空。
进一步，查看同步sql：

```oracle
SELECT  ...
from    tinstruction A, tcombi B 
WHERE  A.L_DIRECT_DATE >= ? AND A.L_DIRECT_TIME >=?  and ...
order by A.L_DAILY_INSTRUCTION_NO;
```

发现时同步的时间区间变成`20240507`了，但是里面我更新的指令都是`20240412`的，所以我在更新的指令不在定义同步任务内。
这是因为指令补漏后，会在系统参数信息表记录一个时间参数dispense_time，值为（date#time），取自本次补漏任务中，所有指令中下达或分发时间最新的data和time，因此，
即使上一次补漏失败了，也不会再重新去补漏。这里是不是可以优化下，如果上次补漏失败，不去更改系统参数信息表的dispense_time值？


<font color='red'>另外还有一个问题，就是如果有人下了个多日指令，比如日初时间是20240417，有人下的指令到了20240507，那今日新下的单日指令都不会被补漏了</font>

<img src="https://cdn.jsdelivr.net/gh/sparkling-wild-fire/picgo@main/blogs/pictures/20240511150120.png" alt="20240511150120" width="850">

这种情况不会出现，只有测试下完多日指令后，将日期回退了，比如从20240507回退到20200412，才会出现这种情况。因为日初只会清除单日指令，不会清除多日指令。


| 定时任务触发时间      | 系统参数表指令分发时间 | O3指令表的指令分发时间                 |
|---------------|-------------|------------------------------|
||| 1->10002;2->100212 |
| 10:05:00(成功)  | 100215      | 1->10002;2->100212           |
|               | 100215      | 1->10002;2->100212;3->100700 |
| 10:10:00(失败)  | 100700      | 1->10002;2->100212;3->100700           |
| 10:15:00      | 100700      | 1->10002;2->100212;3->100700           |

