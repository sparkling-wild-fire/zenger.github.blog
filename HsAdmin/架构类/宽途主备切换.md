# 宽途主备切换

## 主备环境总览

<img src="https://cdn.jsdelivr.net/gh/sparkling-wild-fire/picgo@main/blogs/pictures/20230523164451.png" alt="20230523164451" width="850" >

主备环境相对于单机模式，旨在主机服务停止后，备机能自动地继续提供服务

## 主备环境的搭建

[参考链接：策略接入平台主备模式配置](http://rdcdocs.hundsun.com/pages/viewpage.action?pageId=44842559)

1. 首先，准备两个机器，然后修改配置文件，
    - `alg_tran_mp.xml`在配置主备环境的路由时，mt节点需要在zk上进行注册。（可通过天鉴部署主备环境，天鉴会向zk注册mt节点）
   
      <img src="https://cdn.jsdelivr.net/gh/sparkling-wild-fire/picgo@main/blogs/pictures/20230523144956.png" alt="20230523144956" width="450" >
    
2. 设置nfs挂载以同步主备机器的UFT数据。
    - 如果主机或备机搭建在Nat内网，需要进行端口映射。[参考链接：nfs穿透NAT挂载](https://blog.csdn.net/chang_qingqing/article/details/120820083)
    - 注意f2端口走udp，t2端口走tcp
   
## 主备机启动与工作流程
   
1. 服务启动：

   - 总体流程：两台服务器互为主备，先启动的机器成为主机，当备机也启动成功后，将寻找同名节点，发送消息通知主机，主机回包确认

   - 具体过程：大致分为预加载、前置适配加载、投资系统基础数据加载三部分；其中，主机启动时会一次性完成这三个阶段，而备机启动成功后，只进行预加载（数据库，线程池插件等全部加载完成），同时，将状态置为`2`（加载状态）。（参考`402999`功能号）


2. 数据同步：
   -  备机主要同步主机的dat文件和redo文件，备机切换成主机时，会加载redo文件中的数据到uft中
   - 为正确落库，主备机要连接同一个本地数据库，同时保持`Todb_*.xml`文件的配置一致
   
3. 主备切换：

    - zk检测到主机切换后，会自动open对应的路由；备机调用`45184006`功能号，将备机标识为主机，进行数据加载，异步加载前置适配，然后调`402999`完成启动

4. 主备模式与单机模式区分：

   - 通过hsadmin可查看当前环境的模式：

        <img src="https://cdn.jsdelivr.net/gh/sparkling-wild-fire/picgo@main/blogs/pictures/20230523150948.png" alt="20230523150948" width="850" >

   - 代码中调用功能号`1403040`获取`svr_mode`值即可,`0`为主备模式，`1`为单机模式

5. 心跳机制：
   - 客户端通过后台的session向宽途发送心跳，后台通过session（O3）或user_token（O45）发送心跳.(但目前O3和O45也是验证的宽途自己的session)
   - 前端调用`402000`:
     - 为实现主备机的无感切换，后台向客户端屏蔽主备机的差异，客户端连接主机后，将向主机的mt节点发送心跳，主机返回`错误号为0的应答包`。
     - 当主机的mt服务停止后，客户端收到心跳`应答包为空`，将停止发送心跳，后续将请求备机的mt.
     - 在备机尝试切换成主机的过程中，客户端的心跳应答包的错误号为`308000000`,当备机成功切换为主机后，心跳应答包中的错误号为`0`.
   - 定时任务`402997`：
     - 每隔10s检查一次，清理掉120s没有心跳的session

## 常见的问题

1. 在主机mt节点停止后，备机启动时状态报错：

   <img src="https://cdn.jsdelivr.net/gh/sparkling-wild-fire/picgo@main/blogs/pictures/20230523154200.png" alt="20230523154200" width="850" >

    这是由于备机同步主机数据发生错误，`df -h`检查挂载目录是否正确

2. 主备机突然连接不上本地数据库：
   
    可能是电脑的防火墙或者服务器节点的防火墙被打开了（公司的电脑会自动开启防火墙）