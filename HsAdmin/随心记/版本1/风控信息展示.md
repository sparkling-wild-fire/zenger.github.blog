# 风控信息展示

## 任务描述

废单信息展示，当前多个页面仅展示【触发风控】，并未展示全部风控信息，需要展开展示全部信息。

402040和402050的处理逻辑有差异，考虑把废单主推的处理统一下

## 设置风控

O3Trade,投资风险设置 => 证券秒买控制 => 新增

<img src="https://cdn.jsdelivr.net/gh/sparkling-wild-fire/picgo@main/blogs/pictures/20230423104435.png" alt="20230423104435" width="450" >

控这只券的所有买卖

测试：

O32：交易所指令 =>  个股指令

宽途：系统设置  =>   提示   =>  预警风控提醒  打开  ；  证券指令  =>  下达指令（其实是证券交易才调的402050）

批量委托：宽途（组合指令+智能交易）；O3trade：指令分发

## 流程

篮子委托：
1. 前端调用`402050`    
2. 转发到流水线插件，调用UFT功能号`440281001`(委托前调用)  =>  lib="fsc_pipeline" 分配一个线程，这个委托的后续处理都交给这个线程
3. => `540281024`  =>  `640281000`(适配文件中，不同的投资系统都有这个适配功能号，对接O3是个异步委托的适配选择器)   =>     market_no=10《股转、北交所》:740281010|*:740281020 
4. => `440280000`   =>  流水线插件    =>   篮子委托适配器`440281000` (UFT功能号，委托申报)   => 从这里开始就是流水调用了，`batch_entrust_asyn_gz.xml`
5. => 适配调用`640281001`(篮子委托请求前处理): busin_class=x:740281041|((special_flag=2)&(market_no=1)&(network_type=1)):740281031|busin_class=k:740281021|market_no=10:740281051|*:`740281011`
   - 后面的适配会调用O3或者O45的功能号，然后再调回来，这种只能先复现再通过看日志发现吗？
6. `440281002`(LS,<font color="red">所以不同的LS可以通过适配文件相互调用</font>)    =>   委托失败【LF_PB适配_异步委托错误处理】,调（`540281030（29）`）,这里异步委托异常后有三个消息主题
    - 包含风控消息的应该就这一个吧`stp.api.entrust_waste`   (0 == @basket_entrust_obj.error_no的分支)
7. => `2402951`主推废单消息，含风控消息（主题：`stp.api.entrust_waste`, 消息：`entrustwaste_msg_obj`）    =>  篮子委托请求前，好像也会主推这个主题消息
    - 批量的吧,不是，非批量的日志文件也有  （else分支）
/、

篮子批量委托：
1. `402040`    =>   `440281003`指令委托   => 应该大差不差
2. `540281002`  =>    比较复杂的适配选择器   
3. =>   `640281003`(返回三个应答结构体)  =>   `440281013` 主推    =>  批量的没有主推`stp.api.entrust_waste`消息啊
4. 难道你是走的[LF_PB适配_异步委托应答主推]，`540281029`,三个主推

## else
`440281002`：
- 请求结构体：`basket_entrust_obj`,`entrust_ei_detail`,`risk_detail_obj`(篮子委托风控明细对象)
- 应答结构体：`risk_detail_obj`(篮子委托风控明细对象)+如下三个主推结构体
- 主推结构体： 废单、委托信息、撤单
  - 主题：`stp.api.entrust_waste`, 消息：`entrustwaste_msg_obj`（这个消息里面该有的数据好像也都有了，是要把`risk_detail_obj`中的相关字段也弄过来吗？）
  - 主题：`stp.api.entrust`, 消息：`entrust_msg_obj`
  - 主题：`stp.api.appendentrustfail`, 消息：`withdrawal_msg_obj`

## 收获

之前我也怀疑不是同一套环境，但是觉得一直都用的是，就没去多想，也懒得想了。同事通过简单的测试就验证了这个问题，确实不是同一套环境  =>  可能是把端口啥的换了？？

## 疑问

首先两个任务都是下委托的报错信息，一个是不能通过风控（虽然提示委托成功，但其实是失败了）成为废单，一个是下委托失败

- O3有详细信息，具体是指的什么（三个应答包吗？我需要将这些包体从O3传到宽途）
  - `因为其他委托失败或者篮子整体失败当前委托失败`应该是后台传的吧

- 我这个主推消息`withdrawal_msg_obj`，缺少的我往这个消息结构体加就是了(应该是传临时结构体，原有结构体+扩展字段)

- 和谁联调啊，怎么批量下委托（`402040和402050`的主推处理逻辑不一样）

- 为什么风控主推里没有的东西，宽途也提示了。 前往是个什么东东，为啥不能前往

- 前端应该有个功能，能够把债券代码转换为名称...

- 批量交易（调的是`402040`）不是组合交易（调用的是`402050`）

- 为啥指令批量下达，没有人调用它