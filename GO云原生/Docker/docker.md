# docker

docker遵循的单一原则，一个容器只运行一个进程; 但也可以运行多个进程，如用作虚拟机。

## 隔离机制

1. 在容器进程启动之前重新挂载它的整个根目录“/”，来为容器提供隔离后的执行环境文件系统 （rootfs）
2. 通过Linux Namespace 创建隔离，决定进程能够看到和使用哪些东西
3. 通过control groups 技术来约束进程对资源的使用


### rootfs：联合文件系统

在传统的Linux操作系统中，首先挂载一个只读的rootfs，当系统检测完整性之后，再将其切换为读写模式；而在Docker架构中，会在只读的rootfs上挂载一个读写层。

<img src="https://cdn.jsdelivr.net/gh/sparkling-wild-fire/picgo@main/blogs/pictures/202304141002205.png" alt="202304141002205" width="450px">

若需要修改文件/etc/hosts，而文件位于只读层，docker会将下层的只读层复制到读写层，并隐藏只读层的该文件


### Linux Namespace

namespace 是 Linux 内核用来隔离内核资源的方式。linux 内核提供的
namespace 技术为 docker 等容器技术的出现和发展提供了基础条件

namaspace有哪些：隔离了IPC(进程间通信)资源、网络相关资源、用户和组ID空间、挂载的文件系统等

### Cgourp

control groups: 控制组，被整合在了linux内核当中，把进程（tasks）放到组??，对组设置
权限，对进程进?控制。可以理解为?户和组的概念，?户会继承它所在组的权限。

解决的问题：

1. 资源控制：cgroup通过进程组对资源总额进?限制。如：程序使?内存时，要为程序设定可以
   使?主机的多少内存，也叫作限额
2. 优先级分配：使?硬件的权重值。当两个程序都需要进程读取cpu，哪个先哪个后，通过优先
   级来进?控制
3. 资源统计：可以统计硬件资源的?量，如：cpu、内存…使?了多?时间
4. 进程控制：可以对进程组实现挂起/恢复的操作，

cgroup子系统有： cpu?系统，cpuset?系统，memory?系统等

查看docker的cgroup和linux namespace:

```shell
docker run
cd /sys/fs/cgroup # 查看cgroup ?系统变化 并找到其对应的PID
cd /proc/{PID}/ns # 查看命名空间
```

## 镜像

镜像的主要特点

1. 分层：由一系列的镜像层组成，每次提交仅保存最上层读写文件系统中被更新过的文件。分层达到了在不同镜像之间共享镜像
   层的效果
2. 写时复制：多容器共享镜像，容器启动时并不需要单独复制一份镜像文件，而是将所有镜像层以只读的方式挂载到一个挂载点，再在上面覆盖一个读写的容器层，只有在docker容器在运行过程中，文件系统发生变化时，才会把变化的文件写到读写层。
3. 内容寻址：
4. 联合挂载：可以在一个挂载点同时挂载多个文件系统，将挂载点的原?录与被挂载内容
   进?整合，使得最终课件的?件系统将会包含整合之后的各个层的?件和?录。（配合分层机制）

registry（注册中?）：简单来说就是docker hub上的镜像库，用来存储你上传的镜像

Repository：由具有某个功能的Docker镜像的所有迭代版本构成的镜像组。我们通常所说的镜像名其实就是指的repository。repository和镜像之
间是什么关系呢？事实上，repository是?个镜像的集合，其中包含了多个不同版本的镜像，使?标签进
?版本区分。


docker commit：

提交?个容器只会保存在提交的那个时刻容器的?件系统的状态，?不是进程状态。

适?场景：
- 构建临时的测试镜像
- 容器被?侵后，使?docker commit，基于被?侵的容器构建镜像，从?保留现场，?便以后追
溯。
除了这两种场景，不建议你使?docker commit来构建?产现?环境的镜像。

主要原因有两个：
- ?docker commit构建的镜像包含了编译构建、安装软件，以及程序运?产?的?量???件，这会
导致镜像体积很?，?常臃肿。
- 使?docker commit构建的镜像会丢失掉所有对该镜像的操作历史，?法还原镜像的构建过程，不利于
镜像的维护

推荐用docker build构建镜像

## dockerfile

Dockerfile是?个创建镜像所有命令的?本?件, 包含了?条条指令和说明, 每条指令构建?
层, 通过docker build命令,根据Dockerfile的内容构建镜像,因此每?条指令的内容, 就是描述该层如
何构建.有了Dockefile, 就可以制定??的docker镜像规则,只需要在Dockerfile上添加或者修改指
令, 就可?成docker 镜像.

dockerfile包含了镜像制作的完整操作流程，其他开发者可以通过 Dockerfile 了解并复现制作
过程;

### docker build 构建流程

- 第?步，docker build会将 context 中的?件打包传给 Docker daemon。
- 第?步，docker build命令向 Docker server 发送 HTTP 请求，请求 Docker server 构建镜像，请求中包
  含了需要的 context 信息。
- 第三步，Docker server 接收到构建请求之后，会执?以下流程来构建镜像：
  - 创建?个临时?录，并将 context 中的?件解压到该?录下。
  - 读取并解析 Dockerfile，遍历其中的指令，根据命令类型分发到不同的模块去执?。
  - Docker 构建引擎为每?条指令创建?个临时容器，在临时容器中执?指令，然后 commit 容器，?
     成?个新的镜像层。 
  - 最后，将所有指令构建出的镜像层合并，形成 build 的最后结果。最后?次 commit ?成的镜像 ID
   就是最终的镜像 ID。

### 镜像缓存

Dockerfile 中的每?条指令都会创建新的镜像层，这些镜像可以被 Docker Daemon 缓存。再次制
作镜像时，Docker 会尽量复?缓存的镜像层（using cache），?不是重新逐层构建，这样可以
节省时间和磁盘空间

Docker 匹配缓存镜像的规则为：遍历缓存中的基础镜像及其?镜像，检查这些镜像的构建指令是否
和当前指令完全?致，如果不?样，则说明缓存不匹配。对于ADD、COPY指令，还会根据?件的校验和
（checksum）来判断添加到镜像中的?件是否相同，如果不相同，则说明缓存不匹配。

### 多阶段构建

Docker 17.05版本以后，新增了Dockerfile多阶段构建。所谓多阶段构建，实际上是允许?个
Dockerfile 中出现多个 FROM 指令。

多个 FROM 指令的意义：

多个 FROM 指令并不是为了?成多根的层关系，最后?成的镜像，仍以最后?条 FROM 为准，之
前的 FROM 会被抛弃，那么之前的FROM ?有什么意义呢？

每?条 FROM 指令都是?个构建阶段，多条 FROM 就是多阶段构建，虽然最后?成的镜像只能是
最后?个阶段的结果，但是，能够将前置阶段中的?件拷?到后边的阶段中，这就是多阶段构建的
最?意义。

最?的使?场景是将编译环境和运?环境分离，?如，之前我们需要构建?个Go语?程序，那么
就需要?到go命令等编译环境

### CMD和 ENTRYpoint

ENTRYPOINT指令和CMD指令类似，都可以让容器每次启动时执?相同的命令，但它们之间?有不
同

## 数据卷

### 数据卷产?背景

Docker的镜像是有?系列的只读层组合?来，当启动?个容器时，Docker加载镜像的所有只读层，
并在最上层加??个读写层。这个设计使得Docker可以提?镜像构建、存储和分发的效率，节省了时间
和存储空间，然?也存在?些问题：

1. 容器中的?件在宿主机上存在形式复杂，不能在宿主机上很?便地对容器中的?件进?访问。
2. 多个容器之间的数据?法共享
3. 当删除容器时，容器产?的数据将丢失。

数据卷 => 文件共享

为了解决这些问题，Docker引?了数据卷（volume）机制。Volume 是存在于?个或多个容器中的
特定?件或?件夹，这个?录以独?于联合?件系统的形式在宿主机中存在，并为数据的共享和持久化
提供便利。
1. volume 在容器创建时就会初始化，在容器运?时就可以使?其中的?件。
2. volume 能在不同的容器之间共享和重?
3. 对volume中数据的操作会?上?效
4. 对volume中数据的操作不会影响镜像本身
5. volume的?存周期独?于容器的?命周期，即使删除容器，volume仍然会存在，没有任何容器使?
   的volume也不会被Docker删除。

创建数据卷 => 挂载数据卷（分为只读挂载 和 读写挂载）

挂载：

将宿主机中指定?录作为volume挂载到容器中的/data?录下，?件夹必须使?绝对路径，如果宿主
机中不存在指定的?录，则会创建?个空?件夹；如果宿主机?件夹已经存在，容器可以通过访问挂载
点/data 从?访问宿主机?件夹中的所有内容。如果容器下原本已经存在/data?件夹，且不为空，那么
容器中?件夹下原有的内容将被隐藏，来保持与宿主机中的?件夹?致

### 共享数据卷

在使?docker run 或docker create创建新容器时，可以使?--volumes-from 标签使得容器与已有
容器共享volume。可以使?多个--volumes-from标签，使得容器与多个已有容器共享volume。

作用：
如果有?些数据，?如配置?件、数据?件等，要在多个容器之间共享，?种常?的做法是创建?
个数据容器，其他的容器与之共享volume。


### 数据卷的备份和迁移

在原有容器 打包 => 备份  =>  在新创建的容器恢复

## 网络

在?台未经特殊?络配置的Ubuntu机器上安装完Docker之后，在宿主机上通过ifconfig命令可以看
到多了?块名为docker0的?卡。该?卡即是docker0?桥，?桥在这?的作?相当于交换机，为连接在
其上的设备转发数据帧。?桥上的veth?卡设备相当于交换机上的端?，可以将多个容器或虚拟机连接
其上，这些端??作在?层，所以是不需要配置IP信息的。

CNM：

CNM（Container Network Model）译为容器?络模型，定义了构建容器虚拟化?络的模型。该模
型主要包含三个核?组件 沙盒、端点、?络。
沙盒：?个沙盒包含了?个容器?络栈的信息。沙盒可以对容器的接?、路由和DNS设置进?管
理。?个沙盒可以有多个端点和?络。 （？？）
端点：?个端点可以加??个沙盒和?个?络。?个端点只可以属于?个?络并且只属于?个沙
盒。
?络：?个?络是?组可以直接互相联通的端点。?个?络可以包含多个端点。

libnetwork: 内置了几种网络驱动，bridge、hast、overlay、remote、null

## 容器编排 compose

主要是将一组业务相关的容器做编排

?络：?个?络是?组可以直接互相联通的端点。?个?络可以包含多个端点。

道使??个 Dockerfile 模板?件，可以让?户很?便的定义?
个单独的应?容器。然?，在?常?作中，经常会碰到需要多个容器相互配合来完成某项任务的情况。
例如要实现?个 Web 项?，除了 Web 服务容器本身，往往还需要再加上后端的数据库服务容器，甚?
还包括负载均衡容器等。

Compose 中有两个重要的概念：
服务 ( service )：?个应?的容器，实际上可以包括若?运?相同镜像的容器实例。
项? ( project )：由?组关联的应?容器组成的?个完整业务单元，在 docker-compose.yml ?件中定义。

## swarm